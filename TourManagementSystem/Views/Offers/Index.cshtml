@model object
@using TourManagementSystem.Models

@{
    ViewData["Title"] = "Our Offers";
    var entityType = ViewData["EntityType"] as string ?? "Hotels";

    // Casting and ViewData retrieval code remains the same as your last version...
    // (Keeping it concise here for brevity, but assume it's all present)
    IEnumerable<HotelViewModel> hotelOffers = null;
    IEnumerable<CarRentalViewModel> carRentalOffers = null;
    IEnumerable<FlightViewModel> flightOffers = null;
    IEnumerable<CruiseViewModel> cruiseOffers = null;
    IEnumerable<ActivityViewModel> activityOffers = null;
    IEnumerable<TripViewModel> tripOffers = null;

    if (entityType == "Hotels" && Model is IEnumerable<HotelViewModel> hotels) { hotelOffers = hotels; }
    else if (entityType == "CarRentals" && Model is IEnumerable<CarRentalViewModel> cars) { carRentalOffers = cars; }
    else if (entityType == "Flights" && Model is IEnumerable<FlightViewModel> flights) { flightOffers = flights; }
    else if (entityType == "Cruises" && Model is IEnumerable<CruiseViewModel> cruises) { cruiseOffers = cruises; }
    else if (entityType == "Activities" && Model is IEnumerable<ActivityViewModel> activities) { activityOffers = activities; }
    else if (entityType == "Trips" && Model is IEnumerable<TripViewModel> trips) { tripOffers = trips; }

    var destination_hotel = ViewData["Destination"] as string;
    var hotelName_hotel = ViewData["HotelName"] as string;
    var checkInDate_hotel = ViewData["CheckInDate"] as string;
    var checkOutDate_hotel = ViewData["CheckOutDate"] as string;
    var adults_hotel = ViewData["Adults"] as int?;
    var children_hotel = ViewData["Children"] as int?;
    var minRating_hotel = ViewData["MinRating"] as int?;
    var maxPrice_hotel = ViewData["MaxPrice"] as decimal?;
    var selectedAmenities_hotel = ViewData["SelectedAmenities"] as List<string> ?? new List<string>();

    var location_car = ViewData["Location"] as string;
    var pickupDate_car = ViewData["PickupDate"] as string;
    var returnDate_car = ViewData["ReturnDate_Car"] as string;
    var carModelKeyword_car = ViewData["CarModelKeyword"] as string;

    var origin_flight = ViewData["Origin"] as string;
    var destination_flight = ViewData["FlightDestination"] as string;
    var departureDate_flight = ViewData["DepartureDate"] as string;
    var returnDate_flight = ViewData["ReturnDate_Flight"] as string;
    var passengers_flight = ViewData["Passengers"] as int? ?? 1;
    var tripType_flight = (ViewData["TripType"] as TripType?) ?? TripType.RoundTrip;

    var destinationRegion_cruise = ViewData["DestinationRegion"] as string;
    var cruiseDeparturePort_cruise = ViewData["CruiseDeparturePort"] as string;
    var cruiseLineName_cruise = ViewData["CruiseLineName"] as string;
    var minCruiseDuration_cruise = ViewData["MinCruiseDuration"] as int?;
    var maxCruiseDuration_cruise = ViewData["MaxCruiseDuration"] as int?;
    var maxCruisePrice_cruise = ViewData["MaxCruisePrice"] as decimal?;
    var departureMonth_cruise = ViewData["DepartureMonth"] as string; // This is "yyyy-MM"

    var activitySearchTerm_activity = ViewData["ActivitySearchTerm"] as string;
    var activityCategory_activity = ViewData["ActivityCategory"] as string;
    var activityDate_activity = ViewData["ActivityDate"] as string;
    var maxActivityDuration_activity = ViewData["MaxActivityDuration"] as int?;
    var maxActivityPrice_activity = ViewData["MaxActivityPrice"] as decimal?;
    var participants_activity = ViewData["Participants"] as int?;

    var tripSearchTerm_trip = ViewData["TripSearchTerm"] as string;
    var startDate_trip = ViewData["StartDate"] as string;
    var travelers_trip = ViewData["Travelers"] as int?;
    var maxTripPrice_trip = ViewData["MaxTripPrice"] as decimal?;

    string FormatDateForInput(string dateStr)
    {
        if (DateTime.TryParse(dateStr, out DateTime dt)) return dt.ToString("yyyy-MM-dd");
        if (!string.IsNullOrEmpty(dateStr) && dateStr.Length == 10 && dateStr.IndexOf('-') == 4 && dateStr.LastIndexOf('-') == 7) return dateStr;
        return string.Empty;
    }
    // For month input, ensure it's in "yyyy-MM" format if a value exists
    string FormatMonthForInput(string monthStr)
    {
        if (DateTime.TryParse(monthStr + "-01", out DateTime dt)) return dt.ToString("yyyy-MM"); // Try parsing as first of month
        if (!string.IsNullOrEmpty(monthStr) && monthStr.Length == 7 && monthStr.IndexOf('-') == 4) return monthStr;
        return string.Empty;
    }

    var checkInDate_hotelValue = FormatDateForInput(checkInDate_hotel);
    var checkOutDate_hotelValue = FormatDateForInput(checkOutDate_hotel);
    var pickupDate_carValue = FormatDateForInput(pickupDate_car);
    var returnDate_carValue = FormatDateForInput(returnDate_car);
    var departureDate_flightValue = FormatDateForInput(departureDate_flight);
    var returnDate_flightValue = FormatDateForInput(returnDate_flight);
    var activityDate_activityValue = FormatDateForInput(activityDate_activity);
    var startDate_tripValue = FormatDateForInput(startDate_trip);
    var departureMonth_cruiseValue = FormatMonthForInput(departureMonth_cruise);
}

@section Styles {
    <link rel="stylesheet" type="text/css" href="~/styles/offers_styles.css">
    <link rel="stylesheet" type="text/css" href="~/styles/offers_responsive.css">
    <style>
        .search_panel_content .search_item {
            margin-bottom: 15px; /* Original margin */
            padding-right: 10px;
            position: relative;
            padding-bottom: 20px; /* Add space for validation message below */
        }

            .search_panel_content .search_item:last-of-type {
                margin-bottom: 15px; /* Ensure consistency */
            }

            .search_panel_content .search_item:last-child {
                padding-right: 0;
            }

        .search_panel_content .button.search_button {
            margin-top: 10px; /* Original margin */
            align-self: flex-end;
        }

        .search_panel_content.d-flex.flex-lg-row > .search_item {
            flex-grow: 1;
            flex-shrink: 1;
            flex-basis: 150px;
            min-width: 140px;
        }

            .search_panel_content.d-flex.flex-lg-row > .search_item.extras {
                flex-basis: 100%;
                min-width: auto;
                margin-top: 10px;
                padding-bottom: 0; /* No extra space needed for extras */
            }

        .search_panel_content.d-flex.flex-lg-row > .button.search_button {
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: auto;
            margin-left: auto;
            padding-bottom: 0;
        }

        .flight_details p, .car_details p, .cruise_details p, .activity_details p, .trip_details p {
            margin-bottom: 0.3rem;
            line-height: 1.4;
            font-size: 0.9em;
        }

        .flight_details strong, .car_details strong, .cruise_details strong, .activity_details strong, .trip_details strong {
            font-weight: 600;
        }

        .offers_image_container .offer_name {
            position: absolute;
            bottom: 5px;
            left: 0;
            width: 100%;
            text-align: center;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 0;
            font-size: 0.9em;
        }

            .offers_image_container .offer_name a {
                color: white;
                text-decoration: none;
            }

                .offers_image_container .offer_name a:hover {
                    text-decoration: underline;
                }

        /* Enhanced Validation message styling */
        .validation-error-message {
            color: #ffffff; /* White text */
            font-size: 0.85em;
            font-weight: 500;
            position: absolute; /* Position relative to .search_item */
            bottom: 0px; /* Position it at the bottom of the padding */
            left: 0;
            width: calc(100% - 10px); /* Adjust width considering parent's padding-right */
            padding: 3px 8px;
            background-color: rgba(220, 53, 69, 0.85); /* Semi-transparent strong red background */
            border-radius: 3px;
            margin-top: 3px; /* Small space from input */
            z-index: 10; /* Ensure it's on top */
            text-shadow: 0 0 2px rgba(0,0,0,0.5); /* Slight shadow for readability */
        }

        .search_input.input-error {
            border: 2px solid #dc3545 !important; /* Stronger error border */
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
    </style>
}

<div class="super_container">
    <!-- Home Banner -->
    <div class="home">
        <div class="home_background parallax-window" data-parallax="scroll" data-image-src="@Url.Content("~/images/about_background.jpg")"></div>
        <div class="home_content"><div class="home_title">our offers</div></div>
    </div>

    <!-- Offers Search Section -->
    <div class="offers">
        <div class="search">
            <div class="search_inner">
                <div class="container fill_height no-padding">
                    <div class="row fill_height no-margin">
                        <div class="col fill_height no-padding">
                            <!-- Search Tabs -->
                            <div class="search_tabs_container">
                                <div class="search_tabs d-flex flex-lg-row flex-column align-items-lg-center align-items-start justify-content-lg-between justify-content-start">
                                    <div class="search_tab @(entityType == "Hotels" ? "active" : "") d-flex flex-row align-items-center justify-content-lg-center justify-content-start" data-entitytype="Hotels"><img src="~/images/suitcase.png" alt="Hotels"><span>hotels</span></div>
                                    <div class="search_tab @(entityType == "CarRentals" ? "active" : "") d-flex flex-row align-items-center justify-content-lg-center justify-content-start" data-entitytype="CarRentals"><img src="~/images/bus.png" alt="Car Rentals">car rentals</div>
                                    <div class="search_tab @(entityType == "Flights" ? "active" : "") d-flex flex-row align-items-center justify-content-lg-center justify-content-start" data-entitytype="Flights"><img src="~/images/departure.png" alt="Flights">flights</div>
                                    <div class="search_tab @(entityType == "Trips" ? "active" : "") d-flex flex-row align-items-center justify-content-lg-center justify-content-start" data-entitytype="Trips"><img src="~/images/island.png" alt="Trips">trips</div>
                                    <div class="search_tab @(entityType == "Cruises" ? "active" : "") d-flex flex-row align-items-center justify-content-lg-center justify-content-start" data-entitytype="Cruises"><img src="~/images/cruise.png" alt="Cruises">cruises</div>
                                    <div class="search_tab @(entityType == "Activities" ? "active" : "") d-flex flex-row align-items-center justify-content-lg-center justify-content-start" data-entitytype="Activities"><img src="~/images/diving.png" alt="Activities">activities</div>
                                </div>
                            </div>

                            <!-- Search Panel (Hotels) -->
                            <div class="search_panel @(entityType == "Hotels" ? "active" : "")" id="hotels_search_panel">
                                <form asp-action="Index" asp-controller="Offers" method="get" class="search_panel_content d-flex flex-lg-row flex-column align-items-lg-stretch align-items-start justify-content-lg-between justify-content-start flex-wrap offer-search-form">
                                    <input type="hidden" name="entityType" value="Hotels" />
                                    <div class="search_item"><div>Destination</div><input type="text" name="destination" value="@destination_hotel" class="destination search_input" placeholder="e.g. Paris"></div>
                                    <div class="search_item"><div>Hotel Name</div><input type="text" name="hotelName" value="@hotelName_hotel" class="hotel_name search_input" placeholder="e.g. Grand Hotel"></div>
                                    <div class="search_item"><div>Check In</div><input type="date" name="checkInDate" value="@checkInDate_hotelValue" class="check_in search_input date-start"></div>
                                    <div class="search_item"><div>Check Out</div><input type="date" name="checkOutDate" value="@checkOutDate_hotelValue" class="check_out search_input date-end"></div>
                                    <div class="search_item"><div>Adults</div><select name="adults" class="dropdown_item_select search_input"><option value="1" selected="@(adults_hotel == 1)">01</option><option value="2" selected="@(adults_hotel == 2)">02</option><option value="3" selected="@(adults_hotel >= 3)">03+</option></select></div>
                                    <div class="search_item"><div>Children</div><select name="children" class="dropdown_item_select search_input"><option value="0" selected="@(children_hotel == 0)">0</option><option value="1" selected="@(children_hotel == 1)">01</option><option value="2" selected="@(children_hotel >= 2)">02+</option></select></div>
                                    <div class="search_item"><div>Min Rating</div><select name="minRating" class="dropdown_item_select search_input"><option value="">Any</option><option value="1" selected="@(minRating_hotel == 1)">1+</option><option value="2" selected="@(minRating_hotel == 2)">2+</option><option value="3" selected="@(minRating_hotel == 3)">3+</option><option value="4" selected="@(minRating_hotel == 4)">4+</option><option value="5" selected="@(minRating_hotel == 5)">5</option></select></div>
                                    <div class="search_item"><div>Max Price</div><input type="number" name="maxPrice" value="@maxPrice_hotel" class="search_input price-input" placeholder="e.g. 200" step="10" min="0"></div>
                                    @*
                                    <div class="search_item extras">
                                        <ul class="search_extras clearfix">
                                            <li class="search_extras_item"><div class="clearfix"><input type="checkbox" name="amenities" value="PetFriendly" id="search_extras_1" class="search_extras_cb" checked="@selectedAmenities_hotel.Contains("PetFriendly")"><label for="search_extras_1">Pet Friendly</label></div></li>
                                            <li class="search_extras_item"><div class="clearfix"><input type="checkbox" name="amenities" value="CarParking" id="search_extras_2" class="search_extras_cb" checked="@selectedAmenities_hotel.Contains("CarParking")"><label for="search_extras_2">Car Parking</label></div></li>
                                            <li class="search_extras_item"><div class="clearfix"><input type="checkbox" name="amenities" value="WirelessInternet" id="search_extras_3" class="search_extras_cb" checked="@selectedAmenities_hotel.Contains("WirelessInternet")"><label for="search_extras_3">Wireless Internet</label></div></li>
                                        </ul>
                                    </div>
                                    *@
                                    <button type="submit" class="button search_button">Search Hotels<span></span><span></span><span></span></button>
                                </form>
                            </div>

                            <!-- Search Panel (Car Rentals) -->
                            <div class="search_panel @(entityType == "CarRentals" ? "active" : "")" id="carrentals_search_panel">
                                <form asp-action="Index" asp-controller="Offers" method="get" class="search_panel_content d-flex flex-lg-row flex-column align-items-lg-stretch align-items-start justify-content-lg-between justify-content-start flex-wrap offer-search-form">
                                    <input type="hidden" name="entityType" value="CarRentals" />
                                    <div class="search_item"><div>Pickup Location</div><input type="text" name="location" value="@location_car" class="destination search_input" placeholder="City, Airport"></div>
                                    <div class="search_item"><div>Pickup Date</div><input type="date" name="pickupDate" value="@pickupDate_carValue" class="check_in search_input date-start"></div>
                                    <div class="search_item"><div>Return Date</div><input type="date" name="returnDate" value="@returnDate_carValue" class="check_out search_input date-end"></div>
                                    <div class="search_item"><div>Car Model/Type</div><input type="text" name="carModelKeyword" value="@carModelKeyword_car" class="search_input" placeholder="e.g. SUV, Economy"></div>
                                    <button type="submit" class="button search_button">Search Cars<span></span><span></span><span></span></button>
                                </form>
                            </div>

                            <!-- Search Panel (Flights) -->
                            <div class="search_panel @(entityType == "Flights" ? "active" : "")" id="flights_search_panel">
                                <form asp-action="Index" asp-controller="Offers" method="get" class="search_panel_content d-flex flex-lg-row flex-column align-items-lg-stretch align-items-start justify-content-lg-between justify-content-start flex-wrap offer-search-form">
                                    <input type="hidden" name="entityType" value="Flights" />
                                    <div class="search_item"><div>Trip Type</div><select name="tripType" class="dropdown_item_select search_input"><option value="@TripType.RoundTrip" selected="@(tripType_flight == TripType.RoundTrip)">Round Trip</option><option value="@TripType.OneWay" selected="@(tripType_flight == TripType.OneWay)">One Way</option></select></div>
                                    <div class="search_item"><div>From</div><input type="text" name="origin" value="@origin_flight" class="search_input" placeholder="Origin City/Airport"></div>
                                    <div class="search_item"><div>To</div><input type="text" name="flightDestination" value="@destination_flight" class="search_input" placeholder="Destination City/Airport"></div>
                                    <div class="search_item"><div>Departure Date</div><input type="date" name="departureDate" value="@departureDate_flightValue" class="search_input date-start"></div>
                                    <div class="search_item"><div>Return Date</div><input type="date" name="returnDate" value="@returnDate_flightValue" class="search_input date-end"></div>
                                    <div class="search_item"><div>Passengers</div><input type="number" name="passengers" value="@passengers_flight" class="search_input" min="1"></div>
                                    <button type="submit" class="button search_button">Search Flights<span></span><span></span><span></span></button>
                                </form>
                            </div>

                            <!-- Search Panel (Trips) -->
                            <div class="search_panel @(entityType == "Trips" ? "active" : "")" id="trips_search_panel">
                                <form asp-action="Index" asp-controller="Offers" method="get" class="search_panel_content d-flex flex-lg-row flex-column align-items-lg-stretch align-items-start justify-content-lg-between justify-content-start flex-wrap offer-search-form">
                                    <input type="hidden" name="entityType" value="Trips" />
                                    <div class="search_item"><div>Destination/Keyword</div><input type="text" name="tripSearchTerm" value="@tripSearchTerm_trip" class="search_input" placeholder="e.g., Italy, Adventure Tour"></div>
                                    <div class="search_item"><div>Start Date (Optional)</div><input type="date" name="startDate" value="@startDate_tripValue" class="search_input date-start"></div>
                                    <div class="search_item"><div>Travelers</div><input type="number" name="travelers" value="@(travelers_trip ?? 1)" class="search_input" min="1"></div>
                                    <div class="search_item"><div>Max Price</div><input type="number" name="maxTripPrice" value="@maxTripPrice_trip" class="search_input price-input" placeholder="e.g. 3000" step="100" min="0"></div>
                                    <button type="submit" class="button search_button">Search Trips<span></span><span></span><span></span></button>
                                </form>
                            </div>

                            <!-- Search Panel (Cruises) -->
                            <div class="search_panel @(entityType == "Cruises" ? "active" : "")" id="cruises_search_panel">
                                <form asp-action="Index" asp-controller="Offers" method="get" class="search_panel_content d-flex flex-lg-row flex-column align-items-lg-stretch align-items-start justify-content-lg-between justify-content-start flex-wrap offer-search-form">
                                    <input type="hidden" name="entityType" value="Cruises" />
                                    <div class="search_item"><div>Destination Region</div><input type="text" name="destinationRegion" value="@destinationRegion_cruise" class="search_input" placeholder="e.g., Caribbean"></div>
                                    <div class="search_item"><div>Departure Port</div><input type="text" name="cruiseDeparturePort" value="@cruiseDeparturePort_cruise" class="search_input" placeholder="e.g., Miami"></div>
                                    <div class="search_item"><div>Cruise Line</div><input type="text" name="cruiseLineName" value="@cruiseLineName_cruise" class="search_input" placeholder="e.g., Royal Caribbean"></div>
                                    <div class="search_item"><div>Departure Month</div><input type="month" name="departureMonth" value="@departureMonth_cruiseValue" class="search_input date-start-month"></div> @* Special class for month input *@
                                    <div class="search_item"><div>Min Duration</div><input type="number" name="minCruiseDuration" value="@minCruiseDuration_cruise" class="search_input" placeholder="Days" min="0"></div>
                                    <div class="search_item"><div>Max Duration</div><input type="number" name="maxCruiseDuration" value="@maxCruiseDuration_cruise" class="search_input" placeholder="Days" min="0"></div>
                                    <div class="search_item"><div>Max Price</div><input type="number" name="maxCruisePrice" value="@maxCruisePrice_cruise" class="search_input price-input" placeholder="e.g., 2000" step="100" min="0"></div>
                                    <button type="submit" class="button search_button">Search Cruises<span></span><span></span><span></span></button>
                                </form>
                            </div>

                            <!-- Search Panel (Activities) -->
                            <div class="search_panel @(entityType == "Activities" ? "active" : "")" id="activities_search_panel">
                                <form asp-action="Index" asp-controller="Offers" method="get" class="search_panel_content d-flex flex-lg-row flex-column align-items-lg-stretch align-items-start justify-content-lg-between justify-content-start flex-wrap offer-search-form">
                                    <input type="hidden" name="entityType" value="Activities" />
                                    <div class="search_item"><div>Activity/Location</div><input type="text" name="activitySearchTerm" value="@activitySearchTerm_activity" class="search_input" placeholder="e.g., City Tour, Paris"></div>
                                    <div class="search_item"><div>Category</div><input type="text" name="activityCategory" value="@activityCategory_activity" class="search_input" placeholder="e.g., Sightseeing"></div>
                                    <div class="search_item"><div>Date</div><input type="date" name="activityDate" value="@activityDate_activityValue" class="search_input date-start"></div>
                                    <div class="search_item"><div>Participants</div><input type="number" name="participants" value="@(participants_activity ?? 1)" class="search_input" min="1"></div>
                                    <div class="search_item"><div>Max Duration (hrs)</div><input type="number" name="maxActivityDuration" value="@maxActivityDuration_activity" class="search_input" placeholder="e.g., 3" min="0"></div>
                                    <div class="search_item"><div>Max Price</div><input type="number" name="maxActivityPrice" value="@maxActivityPrice_activity" class="search_input price-input" placeholder="e.g., 100" step="10" min="0"></div>
                                    <button type="submit" class="button search_button">Search Activities<span></span><span></span><span></span></button>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Offers Grid Display Area (Content remains the same as your last version) -->
        <div class="container">
            <div class="row">
                <div class="col-lg-1 temp_col"></div>
                <div class="col-lg-11">
                    <!-- Offers Sorting -->
                    <div class="offers_sorting_container">
                        @* Sorting UI remains the same *@
                        <ul class="offers_sorting">
                            @if (entityType == "Hotels")
                            {
                                <li><span class="sorting_text">price</span><i class="fa fa-chevron-down"></i><ul><li class="sort_btn" data-isotope-option='{ "sortBy": "original-order" }'>show all</li><li class="sort_btn" data-isotope-option='{ "sortBy": "price" }'>ascending</li></ul></li>
                                <li><span class="sorting_text">stars</span><i class="fa fa-chevron-down"></i><ul><li class="filter_btn" data-filter="*">show all</li><li class="sort_btn" data-isotope-option='{ "sortBy": "stars" }'>ascending</li><li class="filter_btn" data-filter=".rating_3">3</li><li class="filter_btn" data-filter=".rating_4">4</li><li class="filter_btn" data-filter=".rating_5">5</li></ul></li>
                            }
                            else if (entityType == "CarRentals" || entityType == "Flights" || entityType == "Cruises" || entityType == "Activities" || entityType == "Trips")
                            {
                                <li><span class="sorting_text">price</span><i class="fa fa-chevron-down"></i><ul><li class="sort_btn" data-isotope-option='{ "sortBy": "original-order" }'>show all</li><li class="sort_btn" data-isotope-option='{ "sortBy": "price" }'>ascending</li></ul></li>
                            }
                            @if (entityType == "Trips" || entityType == "Cruises")
                            {
                                <li><span class="sorting_text">duration</span><i class="fa fa-chevron-down"></i><ul><li class="sort_btn" data-isotope-option='{ "sortBy": "duration" }'>shortest</li></ul></li>
                            }
                            <li><span class="sorting_text">name/title</span><i class="fa fa-chevron-down"></i><ul><li class="sort_btn" data-isotope-option='{ "sortBy": "original-order" }'>default</li><li class="sort_btn" data-isotope-option='{ "sortBy": "name" }'>alphabetical</li></ul></li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="offers_grid">
                        @* ... Your existing offer display logic for each entity type ... *@
                        @* (This part remains unchanged from your provided code) *@
                        @if (TempData["InfoMessage"] != null)
                        {
                            <div class="col-12 text-center" style="padding: 40px; min-height: 150px;"><h4>@TempData["InfoMessage"]</h4></div>
                        }
                        else if (entityType == "Hotels" && hotelOffers != null && hotelOffers.Any())
                        {
                            foreach (var hotel in hotelOffers)
                            {
                                <div class="offers_item rating_@hotel.Rating" data-price="@hotel.PricePerNight" data-stars="@hotel.Rating" data-name="@hotel.Name">
                                    <div class="row">
                                        <div class="col-lg-1 temp_col"></div>
                                        <div class="col-lg-3 col-1680-4">
                                            <div class="offers_image_container">
                                                @{
                                                    var imageUrl = !string.IsNullOrEmpty(hotel.PrimaryImageUrl) ? Url.Content(hotel.PrimaryImageUrl) : Url.Content("~/images/default_offer.jpg");
                                                }
                                                <div class="offers_image_background" style="background-image:url('@imageUrl')"></div>
                                                <div class="offer_name"><a asp-action="Details" asp-controller="Offers" asp-route-id="@hotel.Id" asp-route-entityType="Hotels">@hotel.Name</a></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-8">
                                            <div class="offers_content">
                                                <div class="offers_price">@hotel.PricePerNight.ToString("C0")<span>per night</span></div>
                                                <div class="rating_r rating_r_@hotel.Rating offers_rating" data-rating="@hotel.Rating">
                                                    @for (int i = 0; i < 5; i++)
                                                    {
                                                        <i class="fa @(i < hotel.Rating ? "fa-star" : "fa-star-o")"></i>
                                                    }
                                                </div>
                                                <p class="offers_text">@(!string.IsNullOrEmpty(hotel.Description) && hotel.Description.Length > 180 ? hotel.Description.Substring(0, 180) + "..." : hotel.Description ?? "No description available.")</p>
                                                <div class="offers_icons">
                                                    <ul class="offers_icons_list">
                                                        <li class="offers_icons_item"><img src="~/images/post.png" alt=""></li>
                                                        <li class="offers_icons_item"><img src="~/images/compass.png" alt=""></li>
                                                        <li class="offers_icons_item"><img src="~/images/bicycle.png" alt=""></li>
                                                        <li class="offers_icons_item"><img src="~/images/sailboat.png" alt=""></li>
                                                    </ul>
                                                </div>
                                                <div class="button book_button"><a asp-controller="Booking" asp-action="Create" asp-route-offerId="@hotel.Id" asp-route-offerType="Hotel">book<span></span><span></span><span></span></a></div>
                                                <div class="offer_reviews">
                                                    <div class="offer_reviews_content">
                                                        <div class="offer_reviews_title">@(hotel.Rating >= 4 ? "Very Good" : (hotel.Rating == 3 ? "Good" : "Okay"))</div>
                                                        <div class="offer_reviews_subtitle">@hotel.AvailableRooms rooms left</div>
                                                    </div>
                                                    <div class="offer_reviews_rating text-center">@hotel.Rating.ToString("0.0")</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else if (entityType == "CarRentals" && carRentalOffers != null && carRentalOffers.Any())
                        {
                            foreach (var car in carRentalOffers)
                            {
                                <div class="offers_item" data-price="@car.PricePerDay" data-name="@car.CarModel">
                                    <div class="row">
                                        <div class="col-lg-1 temp_col"></div>
                                        <div class="col-lg-3 col-1680-4">
                                            <div class="offers_image_container">
                                                @{
                                                    var carImgUrl = !string.IsNullOrEmpty(car.ImageUrl) ? Url.Content(car.ImageUrl) : Url.Content("~/images/default_car.jpg");
                                                }
                                                <div class="offers_image_background" style="background-image:url('@carImgUrl')"></div>
                                                <div class="offer_name"><a asp-action="Details" asp-controller="Offers" asp-route-id="@car.Id" asp-route-entityType="CarRentals">@car.CarModel</a></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-8">
                                            <div class="offers_content car_details">
                                                <div class="offers_price">@car.PricePerDay.ToString("C0")<span>per day</span></div>
                                                <p style="margin-top:10px;">
                                                    <strong>Company:</strong> @car.Company<br>
                                                    <strong>Location:</strong> @car.Location
                                                </p>
                                                <div class="button book_button" style="margin-top:15px;"><a asp-controller="Booking" asp-action="Create" asp-route-offerId="@car.Id" asp-route-offerType="CarRental">details<span></span><span></span><span></span></a></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else if (entityType == "Flights" && flightOffers != null && flightOffers.Any())
                        {
                            foreach (var flight in flightOffers)
                            {
                                <div class="offers_item" data-price="@flight.Price" data-name="@flight.Airline to @flight.ArrivalCity" data-departure="@flight.DepartureTime.ToString("s")">
                                    <div class="row">
                                        <div class="col-lg-1 temp_col"></div>
                                        <div class="col-lg-3 col-1680-4">
                                            <div class="offers_image_container">
                                                @{
                                                    var flightImgUrl = !string.IsNullOrEmpty(flight.AirlineLogoUrl) ? Url.Content(flight.AirlineLogoUrl) : Url.Content("~/images/default_flight.png");
                                                }
                                                <div class="offers_image_background" style="background-image:url('@flightImgUrl'); background-size: contain; background-repeat:no-repeat; background-position:center;"></div>
                                                <div class="offer_name"><a asp-action="Details" asp-controller="Offers" asp-route-id="@flight.Id" asp-route-entityType="Flights">@flight.Airline - @flight.FlightNumber</a></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-8">
                                            <div class="offers_content flight_details">
                                                <div class="offers_price">@flight.Price.ToString("C0") <span>@((flight.SearchedTripType == TripType.RoundTrip ? "round trip" : "one way"))</span></div>
                                                <p style="margin-top:10px;">
                                                    <strong>From:</strong> @flight.DepartureCity <strong>To:</strong> @flight.ArrivalCity<br>
                                                    <strong>Departs:</strong> @flight.DepartureTime.ToString("MMM dd, yyyy HH:mm")<br>
                                                    <strong>Arrives:</strong> @flight.ArrivalTime.ToString("MMM dd, yyyy HH:mm")<br>
                                                    <strong>Duration:</strong> @flight.Duration
                                                </p>
                                                <div class="button book_button" style="margin-top:15px;"><a asp-controller="Booking" asp-action="Create" asp-route-offerId="@flight.Id" asp-route-offerType="Flight">details<span></span><span></span><span></span></a></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else if (entityType == "Trips" && tripOffers != null && tripOffers.Any())
                        {
                            foreach (var trip in tripOffers)
                            {
                                <div class="offers_item" data-price="@trip.Price" data-name="@trip.Title" data-duration="@trip.DurationDays">
                                    <div class="row">
                                        <div class="col-lg-1 temp_col"></div>
                                        <div class="col-lg-3 col-1680-4">
                                            <div class="offers_image_container">
                                                @{
                                                    var tripImgUrl = !string.IsNullOrEmpty(trip.ImageUrl) ? Url.Content(trip.ImageUrl) : Url.Content("~/images/default_trip.jpg");
                                                }
                                                <div class="offers_image_background" style="background-image:url('@tripImgUrl')"></div>
                                                <div class="offer_name"><a asp-action="Details" asp-controller="Offers" asp-route-id="@trip.Id" asp-route-entityType="Trips">@trip.Title</a></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-8">
                                            <div class="offers_content trip_details">
                                                <div class="offers_price">@trip.Price.ToString("C0") <span>total</span></div>
                                                <p style="margin-top:10px;">
                                                    <strong>Destination(s):</strong> @trip.Destination<br>
                                                    <strong>Duration:</strong> @trip.DurationDays days
                                                </p>
                                                <p class="offers_text">@(!string.IsNullOrEmpty(trip.Description) && trip.Description.Length > 100 ? trip.Description.Substring(0, 100) + "..." : trip.Description)</p>
                                                <div class="button book_button" style="margin-top:15px;"><a asp-controller="Booking" asp-action="Create" asp-route-offerId="@trip.Id" asp-route-offerType="Trip">details<span></span><span></span><span></span></a></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else if (entityType == "Cruises" && cruiseOffers != null && cruiseOffers.Any())
                        {
                            foreach (var cruise in cruiseOffers)
                            {
                                <div class="offers_item" data-price="@cruise.Price" data-name="@cruise.CruiseLine @cruise.Destination" data-duration="@cruise.DurationDays">
                                    <div class="row">
                                        <div class="col-lg-1 temp_col"></div>
                                        <div class="col-lg-3 col-1680-4">
                                            <div class="offers_image_container">
                                                @{
                                                    var cruiseImgUrl = !string.IsNullOrEmpty(cruise.ImageUrl) ? Url.Content(cruise.ImageUrl) : Url.Content("~/images/default_cruise.jpg");
                                                }
                                                <div class="offers_image_background" style="background-image:url('@cruiseImgUrl')"></div>
                                                <div class="offer_name"><a asp-action="Details" asp-controller="Offers" asp-route-id="@cruise.Id" asp-route-entityType="Cruises">@cruise.ItinerarySummary</a></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-8">
                                            <div class="offers_content cruise_details">
                                                <div class="offers_price">@cruise.Price.ToString("C0") <span>total</span></div>
                                                <p style="margin-top:10px;">
                                                    <strong>Cruise Line:</strong> @cruise.CruiseLine<br>
                                                    <strong>Sails from:</strong> @cruise.DeparturePort<br>
                                                    <strong>To:</strong> @cruise.Destination<br>
                                                    <strong>Duration:</strong> @cruise.DurationDays days
                                                </p>
                                                <div class="button book_button" style="margin-top:15px;"><a asp-controller="Booking" asp-action="Create" asp-route-offerId="@cruise.Id" asp-route-offerType="Cruise">details<span></span><span></span><span></span></a></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else if (entityType == "Activities" && activityOffers != null && activityOffers.Any())
                        {
                            foreach (var activity in activityOffers)
                            {
                                <div class="offers_item" data-price="@activity.Price" data-name="@activity.Name">
                                    <div class="row">
                                        <div class="col-lg-1 temp_col"></div>
                                        <div class="col-lg-3 col-1680-4">
                                            <div class="offers_image_container">
                                                @{
                                                    var activityImgUrl = !string.IsNullOrEmpty(activity.ImageUrl) ? Url.Content(activity.ImageUrl) : Url.Content("~/images/default_activity.jpg");
                                                }
                                                <div class="offers_image_background" style="background-image:url('@activityImgUrl')"></div>
                                                <div class="offer_name"><a asp-action="Details" asp-controller="Offers" asp-route-id="@activity.Id" asp-route-entityType="Activities">@activity.Name</a></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-8">
                                            <div class="offers_content activity_details">
                                                <div class="offers_price">@activity.Price.ToString("C0") <span>per person</span></div>
                                                <p style="margin-top:10px;">
                                                    <strong>Location:</strong> @activity.Location<br>
                                                    <strong>Category:</strong> @activity.Category<br>
                                                    <strong>Duration:</strong> @activity.DurationHours hours
                                                </p>
                                                <p class="offers_text">@(!string.IsNullOrEmpty(activity.Description) && activity.Description.Length > 100 ? activity.Description.Substring(0, 100) + "..." : activity.Description)</p>
                                                <div class="button book_button" style="margin-top:15px;"><a asp-controller="Booking" asp-action="Create" asp-route-offerId="@activity.Id" asp-route-offerType="Activity">details<span></span><span></span><span></span></a></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else if (TempData["InfoMessage"] == null)
                        {
                            <div class="col-12 text-center" style="padding: 40px; min-height: 150px;"><h4>No @(entityType.ToLower().Replace("rentals", " rental")) offers found.</h4></div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/plugins/Isotope/isotope.pkgd.min.js"></script>
    <script src="~/plugins/imagesloaded/imagesloaded.pkgd.min.js"></script>
    <script src="~/plugins/parallax-js-master/parallax.min.js"></script>
    <script src="~/js/offers_custom.js"></script>

    <script>
        $(document).ready(function () {
            // Function to clear validation messages for a given form
            function clearValidationMessages(form) {
                $(form).find('.validation-error-message').remove();
                $(form).find('.input-error').removeClass('input-error');
            }

            // Function to display a validation message after an input field
            function showValidationMessage(inputField, message) {
                clearValidationMessage(inputField);
                $(inputField).addClass('input-error');
                // Insert after the input, or after its parent if it's in an input-group or similar
                var $parentSearchItem = $(inputField).closest('.search_item');
                if ($parentSearchItem.length) {
                    $parentSearchItem.append('<span class="validation-error-message">' + message + '</span>');
                } else {
                    $(inputField).after('<span class="validation-error-message">' + message + '</span>');
                }
            }

            function clearValidationMessage(inputField) {
                $(inputField).removeClass('input-error');
                var $parentSearchItem = $(inputField).closest('.search_item');
                if ($parentSearchItem.length) {
                    $parentSearchItem.find('.validation-error-message').remove();
                } else {
                    $(inputField).next('.validation-error-message').remove();
                }
            }

            // Get today's date in YYYY-MM-DD format, ignoring time zone for simple comparison
            function getTodayDateString() {
                var today = new Date();
                var year = today.getFullYear();
                var month = ('0' + (today.getMonth() + 1)).slice(-2);
                var day = ('0' + today.getDate()).slice(-2);
                return year + '-' + month + '-' + day;
            }
            var todayDateString = getTodayDateString();


            $('.offer-search-form').on('submit', function (e) {
                var form = this;
                var isValid = true;
                clearValidationMessages(form);

                // 1. Date Validation: Start date must be before end date & not in the past
                var $startDateField = $(form).find('.date-start');
                var $endDateField = $(form).find('.date-end');
                var $startMonthField = $(form).find('.date-start-month'); // For cruise departureMonth

                // Validate start date fields (date-start and date-start-month)
                var $actualStartDateField = $startDateField.length ? $startDateField : ($startMonthField.length ? $startMonthField : null);

                if ($actualStartDateField && $actualStartDateField.length) {
                    var startDateVal = $actualStartDateField.val();
                    if (startDateVal) {
                        var isMonthInput = $actualStartDateField.hasClass('date-start-month');
                        var startDateToCompare = isMonthInput ? startDateVal + "-01" : startDateVal; // Use first day of month for month inputs

                        if (new Date(startDateToCompare) < new Date(todayDateString)) {
                             showValidationMessage($actualStartDateField, 'Start date cannot be in the past.');
                             isValid = false;
                        }

                        // If there's an end date field, validate the range
                        if ($endDateField.length && $endDateField.val()) {
                            var endDateVal = $endDateField.val();
                            if (new Date(startDateToCompare) >= new Date(endDateVal)) {
                                showValidationMessage($endDateField, 'End date must be after start date.');
                                isValid = false;
                            }
                        }
                    }
                }


                // Additional validation for round trip flights
                if ($(form).closest('#flights_search_panel').length > 0) {
                    var tripType = $(form).find('select[name="tripType"]').val();
                    var departureDate = $(form).find('input[name="departureDate"]').val();
                    var returnDate = $(form).find('input[name="returnDate"]').val();

                    if (tripType === '@TripType.RoundTrip.ToString()') {
                        if (!returnDate) {
                            showValidationMessage($(form).find('input[name="returnDate"]'), 'Return date is required for round trips.');
                            isValid = false;
                        } else if (departureDate && returnDate && new Date(departureDate) >= new Date(returnDate)) {
                            // This date range check is already covered above if .date-start and .date-end are used correctly
                            // but kept here as a specific check for flights form clarity
                             showValidationMessage($(form).find('input[name="returnDate"]'), 'Return date must be after departure date.');
                             isValid = false;
                        }
                    }
                }


                // 2. Max Price Validation
                $(form).find('.price-input').each(function () {
                    var $priceField = $(this);
                    var priceValue = $priceField.val();
                    if (priceValue) {
                        var price = parseFloat(priceValue);
                        if (isNaN(price) || price < 0) {
                            showValidationMessage($priceField, 'Price must be a non-negative number.');
                            isValid = false;
                        } else if (!/^\d*\.?\d*$/.test(priceValue)) {
                            showValidationMessage($priceField, 'Please enter a valid price.');
                            isValid = false;
                        }
                    }
                });

                // 3. General Numeric Input (for type=number, ensure no non-numeric chars somehow slipped in)
                $(form).find('input[type="number"]').each(function () {
                    var $numericField = $(this);
                    var numericValue = $numericField.val();
                    // HTML5 type="number" should prevent most non-numeric, this is a fallback
                    if (numericValue && isNaN(parseFloat(numericValue)) && !/^-?\d*\.?\d*$/.test(numericValue)) {
                         showValidationMessage($numericField, 'Please enter a valid number.');
                         isValid = false;
                    }
                     // For min="0" fields, ensure value is not negative if entered
                    if (numericValue && $numericField.attr('min') === '0' && parseFloat(numericValue) < 0) {
                        showValidationMessage($numericField, 'Value cannot be negative.');
                        isValid = false;
                    }
                });


                if (!isValid) {
                    e.preventDefault();
                }
            });

            $('.offer-search-form .search_input').on('input change keyup', function() {
                clearValidationMessage(this); // Clear specific field error on change

                var form = $(this).closest('form');
                var $startDateField = $(form).find('.date-start');
                var $endDateField = $(form).find('.date-end');
                var $startMonthField = $(form).find('.date-start-month');
                var $actualStartDateField = $startDateField.length ? $startDateField : ($startMonthField.length ? $startMonthField : null);

                // Re-validate related date fields if one changes
                if (($(this).is($actualStartDateField) || $(this).is($endDateField)) && $actualStartDateField && $endDateField.val()) {
                    var startDateVal = $actualStartDateField.val();
                    var endDateVal = $endDateField.val();
                    var isMonthInput = $actualStartDateField.hasClass('date-start-month');
                    var startDateToCompare = isMonthInput ? startDateVal + "-01" : startDateVal;

                    if (startDateVal && endDateVal) {
                        if (new Date(startDateToCompare) < new Date(endDateVal)) {
                            clearValidationMessage($actualStartDateField);
                            clearValidationMessage($endDateField);
                        }
                    }
                     if (startDateVal && new Date(startDateToCompare) >= new Date(todayDateString)) {
                        clearValidationMessage($actualStartDateField);
                    }
                }
                 // Price field re-validation
                if ($(this).hasClass('price-input')) {
                    var priceValue = $(this).val();
                    if (!priceValue || (parseFloat(priceValue) >= 0 && /^\d*\.?\d*$/.test(priceValue))) {
                         clearValidationMessage(this);
                    }
                }
                 // Numeric fields re-validation (for min attribute)
                if ($(this).is('input[type="number"]') && $(this).attr('min') === '0') {
                    var numVal = $(this).val();
                     if (!numVal || parseFloat(numVal) >= 0) {
                        clearValidationMessage(this);
                    }
                }
            });
        });
    </script>
}